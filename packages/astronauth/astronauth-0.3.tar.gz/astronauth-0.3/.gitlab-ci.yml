default:
  image: python:3.10  # use latest for building/linting
  before_script:
    - python --version # For debugging
    - python -m pip install --upgrade pip
    - pip install --upgrade tox twine
  cache:
    paths:
      - .cache/pip
      # Do not cache .tox, to recreate virtualenvs for every step
  interruptible: true

stages:
  - lint
  # No testing, astronauth only overrides templates
  - package
  - integration
  - publish # publish instead of deploy

# Caching of dependencies to speed up builds
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

run_black:
  stage: lint
  script:
    - tox -e black
  allow_failure: true

run_flake8:
  stage: lint
  script:
    - tox -e pep8
  allow_failure: true

run_pylint:
  stage: lint
  script:
    - tox -e pylint
  allow_failure: true

package_files:
  stage: package
  artifacts:
    expire_in: 1w
    paths:
      - dist/*
  script:
    - tox -e build

publish_on_gitlab:
  stage: publish
  environment: gitlab
  needs:
    - package_files
  when: manual
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "run twine for gitlab"
    - |
      TWINE_PASSWORD=${CI_JOB_TOKEN} \
      TWINE_USERNAME=gitlab-ci-token \
      python -m twine upload \
      --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
